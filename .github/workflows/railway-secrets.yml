name: Railway Secret Management

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - generate-and-set
          - rotate
          - verify
      service_name:
        description: 'Railway service name (default: umami)'
        required: false
        default: 'umami'
  # schedule:
  #   # Optional: Auto-rotate secrets monthly (disabled by default)
  #   # Uncomment to enable: every 1st of the month at 2am UTC
  #   - cron: '0 2 1 * *'

env:
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

jobs:
  manage-secrets:
    runs-on: ubuntu-latest
    name: ${{ github.event.inputs.action || 'scheduled-rotation' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: |
          npm install -g @railway/cli
          railway --version

      - name: Verify Railway authentication
        run: |
          if [ -z "$RAILWAY_TOKEN" ]; then
            echo "âŒ RAILWAY_TOKEN secret not set"
            echo "Set it in GitHub Settings â†’ Secrets â†’ Actions"
            echo "Get token from: https://railway.app/account/tokens"
            exit 1
          fi
          echo "âœ… Railway token configured"

      - name: Generate secrets
        id: generate
        run: |
          echo "ðŸ” Generating secure secrets..."
          HASH_SALT=$(openssl rand -hex 32)
          NEXTAUTH_SECRET=$(openssl rand -hex 32)
          POSTGRES_PASSWORD=$(openssl rand -hex 32)

          # Mask secrets in logs
          echo "::add-mask::$HASH_SALT"
          echo "::add-mask::$NEXTAUTH_SECRET"
          echo "::add-mask::$POSTGRES_PASSWORD"

          # Export for next steps
          echo "HASH_SALT=$HASH_SALT" >> $GITHUB_OUTPUT
          echo "NEXTAUTH_SECRET=$NEXTAUTH_SECRET" >> $GITHUB_OUTPUT
          echo "POSTGRES_PASSWORD=$POSTGRES_PASSWORD" >> $GITHUB_OUTPUT

          echo "âœ… Secrets generated successfully"

      - name: Link Railway project
        run: |
          # Link to Railway project (requires RAILWAY_TOKEN)
          railway link ${{ secrets.RAILWAY_PROJECT_ID }}
          echo "âœ… Linked to Railway project"

      - name: Set secrets in Railway
        if: github.event.inputs.action == 'generate-and-set' || github.event.inputs.action == 'rotate'
        env:
          HASH_SALT: ${{ steps.generate.outputs.HASH_SALT }}
          NEXTAUTH_SECRET: ${{ steps.generate.outputs.NEXTAUTH_SECRET }}
          POSTGRES_PASSWORD: ${{ steps.generate.outputs.POSTGRES_PASSWORD }}
        run: |
          SERVICE="${{ github.event.inputs.service_name || 'umami' }}"

          echo "ðŸ”„ Setting secrets for Railway service: $SERVICE"

          # Set secrets using Railway CLI
          railway variables set HASH_SALT="$HASH_SALT" --service "$SERVICE"
          railway variables set NEXTAUTH_SECRET="$NEXTAUTH_SECRET" --service "$SERVICE"
          railway variables set POSTGRES_PASSWORD="$POSTGRES_PASSWORD" --service "$SERVICE"

          echo "âœ… Secrets set successfully"
          echo "âš ï¸  Railway will trigger redeployment automatically"

      - name: Set additional environment variables
        if: github.event.inputs.action == 'generate-and-set'
        run: |
          SERVICE="${{ github.event.inputs.service_name || 'umami' }}"

          echo "âš™ï¸  Setting additional environment variables..."

          # Database configuration
          railway variables set DATABASE_TYPE=postgresql --service "$SERVICE"

          # Security & Analytics
          railway variables set DISABLE_TELEMETRY=1 --service "$SERVICE"
          railway variables set NEXT_TELEMETRY_DISABLED=1 --service "$SERVICE"
          railway variables set CLIENT_IP_HEADER=CF-Connecting-IP --service "$SERVICE"

          # Production settings
          railway variables set NODE_ENV=production --service "$SERVICE"
          railway variables set PORT=3000 --service "$SERVICE"

          echo "âœ… Environment variables configured"

      - name: Verify secrets
        if: github.event.inputs.action == 'verify'
        run: |
          SERVICE="${{ github.event.inputs.service_name || 'umami' }}"

          echo "ðŸ” Verifying Railway secrets for service: $SERVICE"

          # List variables (values are masked by Railway)
          railway variables --service "$SERVICE" | grep -E "(HASH_SALT|NEXTAUTH_SECRET|POSTGRES_PASSWORD|DATABASE_TYPE|NODE_ENV)" || echo "No secrets found"

          echo "âœ… Verification complete"

      - name: Store secrets backup (encrypted)
        if: github.event.inputs.action == 'generate-and-set' || github.event.inputs.action == 'rotate'
        env:
          HASH_SALT: ${{ steps.generate.outputs.HASH_SALT }}
          NEXTAUTH_SECRET: ${{ steps.generate.outputs.NEXTAUTH_SECRET }}
          POSTGRES_PASSWORD: ${{ steps.generate.outputs.POSTGRES_PASSWORD }}
        run: |
          mkdir -p .secrets-backup

          # Create encrypted backup (requires GPG_PASSPHRASE secret)
          if [ -n "${{ secrets.GPG_PASSPHRASE }}" ]; then
            cat > .secrets-backup/secrets-$(date +%Y%m%d-%H%M%S).env <<EOF
          HASH_SALT=$HASH_SALT
          NEXTAUTH_SECRET=$NEXTAUTH_SECRET
          POSTGRES_PASSWORD=$POSTGRES_PASSWORD
          GENERATED_AT=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          GENERATED_BY=GitHub Actions (Workflow ${{ github.run_id }})
          EOF

            # Encrypt backup
            gpg --symmetric --cipher-algo AES256 --passphrase "${{ secrets.GPG_PASSPHRASE }}" \
              .secrets-backup/secrets-$(date +%Y%m%d-%H%M%S).env

            rm .secrets-backup/secrets-*.env
            echo "âœ… Encrypted backup created"
          else
            echo "âš ï¸  GPG_PASSPHRASE not set, skipping backup encryption"
            echo "ðŸ’¡ Set GPG_PASSPHRASE secret to enable encrypted backups"
          fi

      - name: Summary
        if: always()
        run: |
          echo "## Railway Secret Management Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Action**: ${{ github.event.inputs.action || 'scheduled-rotation' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Service**: ${{ github.event.inputs.service_name || 'umami' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ github.event.inputs.action }}" = "verify" ]; then
            echo "âœ… Secrets verified successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Secrets generated and set successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸  **Important**: Railway will automatically redeploy the service" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "1. Monitor deployment in Railway dashboard" >> $GITHUB_STEP_SUMMARY
            echo "2. Verify health check: \`curl -I https://umami.cjunker.dev/api/heartbeat\`" >> $GITHUB_STEP_SUMMARY
            echo "3. Test login with new credentials" >> $GITHUB_STEP_SUMMARY
          fi
